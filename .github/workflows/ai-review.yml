name: ğŸ¤– AI Chat Quality Review

on:
  pull_request:
    paths:
      - 'assets/js/chat-ai.js'
      - 'assets/js/chat-ui.js'
      - 'assets/js/app.js'
      - 'assets/js/data-manager.js'
      - 'docs/ai/**'
      - 'tests/conversational/**'
  push:
    branches:
      - main
      - develop
    paths:
      - 'assets/js/chat-ai.js'
      - 'assets/js/chat-ui.js'

jobs:
  architecture-review:
    name: ğŸ—ï¸ Architecture Compliance
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check LLM doesn't calculate
        run: |
          echo "ğŸ” Verificando se LLM nÃ£o calcula valores diretamente..."
          
          # Procurar por cÃ¡lculos diretos no chat-ai.js (fora do calculateQuotation)
          if grep -n "const.*=.*\*\|const.*=.*+\|const.*=.*-\|const.*=.*/\|let.*=.*\*\|let.*=.*+\|let.*=.*-\|let.*=.*/" assets/js/chat-ai.js | grep -v "calculateQuotation" | grep -v "parseTimeToMinutes" | grep -v "formatCurrency" | grep -v "Math.floor\|Math.random" | grep -v "//"; then
            echo "âŒ CRÃTICO: LLM estÃ¡ calculando valores diretamente!"
            echo "O LLM deve chamar calculateQuotation(), nÃ£o fazer cÃ¡lculos."
            exit 1
          fi
          
          echo "âœ… OK: LLM nÃ£o calcula valores diretamente"

      - name: Check confirmation is mandatory
        run: |
          echo "ğŸ” Verificando se confirmaÃ§Ã£o Ã© obrigatÃ³ria..."
          
          # Verificar se generateQuotation sÃ³ Ã© chamado apÃ³s confirmaÃ§Ã£o
          if ! grep -q "waitingForFinalConfirmation\|isConfirmation" assets/js/chat-ai.js; then
            echo "âŒ CRÃTICO: Sistema de confirmaÃ§Ã£o nÃ£o implementado!"
            exit 1
          fi
          
          echo "âœ… OK: Sistema de confirmaÃ§Ã£o implementado"

      - name: Check audit logs exist
        run: |
          echo "ğŸ” Verificando logs de auditoria..."
          
          # Verificar se logs existem
          if ! grep -q "logInferredParameter\|logUserConfirmation\|logCommandInterpretation" assets/js/chat-ai.js; then
            echo "âš ï¸ AVISO: Logs de auditoria podem estar incompletos"
          fi
          
          echo "âœ… OK: Logs de auditoria presentes"

  prompt-quality:
    name: ğŸ’¬ Prompt Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check conversational patterns
        run: |
          echo "ğŸ” Verificando padrÃµes conversacionais..."
          
          # Verificar se hÃ¡ responses conversacionais
          if ! grep -q "responses\[\]\|responses = \[" assets/js/chat-ai.js; then
            echo "âš ï¸ AVISO: Poucas variaÃ§Ãµes de resposta detectadas"
          fi
          
          # Verificar se aceita mÃºltiplas formas de input
          if ! grep -q "includes\|match\|test" assets/js/chat-ai.js; then
            echo "âš ï¸ AVISO: Flexibilidade de input pode estar limitada"
          fi
          
          echo "âœ… OK: PadrÃµes conversacionais detectados"

      - name: Check for context maintenance
        run: |
          echo "ğŸ” Verificando manutenÃ§Ã£o de contexto..."
          
          # Verificar se hÃ¡ gerenciamento de contexto
          if ! grep -q "currentContext\|conversationHistory" assets/js/chat-ai.js; then
            echo "âŒ CRÃTICO: Contexto nÃ£o estÃ¡ sendo mantido!"
            exit 1
          fi
          
          echo "âœ… OK: Contexto sendo mantido"

  voice-parity:
    name: ğŸ¤ Voice-Text Parity
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check voice uses same pipeline
        run: |
          echo "ğŸ” Verificando paridade voz-texto..."
          
          # Verificar se voz chama processUserInput
          if grep -q "handleVoiceInput" assets/js/chat-ai.js; then
            if ! grep -A 5 "handleVoiceInput" assets/js/chat-ai.js | grep -q "processUserInput"; then
              echo "âŒ CRÃTICO: Voz nÃ£o usa mesmo pipeline que texto!"
              exit 1
            fi
          fi
          
          echo "âœ… OK: Voz usa mesmo pipeline"

      - name: Check silence detection
        run: |
          echo "ğŸ” Verificando detecÃ§Ã£o de silÃªncio..."
          
          # Verificar se hÃ¡ tratamento de silÃªncio
          if ! grep -q "silenceTimer\|silenceDelay" assets/js/chat-ai.js; then
            echo "âš ï¸ AVISO: DetecÃ§Ã£o de silÃªncio pode nÃ£o estar implementada"
          fi
          
          echo "âœ… OK: DetecÃ§Ã£o de silÃªncio presente"

  test-coverage:
    name: ğŸ§ª Test Coverage Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check test files exist
        run: |
          echo "ğŸ” Verificando existÃªncia de testes..."
          
          # Verificar se hÃ¡ documentaÃ§Ã£o de testes
          if [ ! -f "tests/conversational/test-scenarios.md" ]; then
            echo "âš ï¸ AVISO: CenÃ¡rios de teste nÃ£o documentados"
          else
            echo "âœ… OK: CenÃ¡rios de teste documentados"
          fi

      - name: Count test scenarios
        run: |
          echo "ğŸ” Contando cenÃ¡rios de teste..."
          
          if [ -f "tests/conversational/test-scenarios.md" ]; then
            TEST_COUNT=$(grep -c "^### Teste" tests/conversational/test-scenarios.md || echo "0")
            echo "ğŸ“Š Total de cenÃ¡rios: $TEST_COUNT"
            
            if [ "$TEST_COUNT" -lt 20 ]; then
              echo "âš ï¸ AVISO: Poucos cenÃ¡rios de teste ($TEST_COUNT < 20)"
            else
              echo "âœ… OK: Boa cobertura de testes ($TEST_COUNT)"
            fi
          fi

  documentation:
    name: ğŸ“š Documentation Review
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check governance docs
        run: |
          echo "ğŸ” Verificando documentaÃ§Ã£o de governanÃ§a..."
          
          if [ ! -f "docs/GOVERNANCE.md" ]; then
            echo "âš ï¸ AVISO: DocumentaÃ§Ã£o de governanÃ§a nÃ£o encontrada"
          else
            echo "âœ… OK: GovernanÃ§a documentada"
          fi

      - name: Check AI prompts docs
        run: |
          echo "ğŸ” Verificando documentaÃ§Ã£o de prompts..."
          
          if [ ! -f "docs/ai/system-prompts.md" ]; then
            echo "âš ï¸ AVISO: Prompts nÃ£o documentados"
          else
            echo "âœ… OK: Prompts documentados"
          fi

      - name: Check conversation flows docs
        run: |
          echo "ğŸ” Verificando documentaÃ§Ã£o de fluxos..."
          
          if [ ! -f "docs/ai/conversation-flows.md" ]; then
            echo "âš ï¸ AVISO: Fluxos conversacionais nÃ£o documentados"
          else
            echo "âœ… OK: Fluxos documentados"
          fi

  security-check:
    name: ğŸ”’ Security Review
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check for hardcoded secrets
        run: |
          echo "ğŸ” Verificando segredos hardcoded..."
          
          if grep -r "api[_-]key\|password\|secret\|token" assets/js/*.js | grep -v "// " | grep "="; then
            echo "âŒ CRÃTICO: PossÃ­veis credenciais hardcoded encontradas!"
            exit 1
          fi
          
          echo "âœ… OK: Sem credenciais hardcoded"

      - name: Check for XSS vulnerabilities
        run: |
          echo "ğŸ” Verificando vulnerabilidades XSS..."
          
          # Verificar se innerHTML Ã© usado sem sanitizaÃ§Ã£o
          if grep -n "innerHTML.*=.*input\|innerHTML.*=.*message" assets/js/*.js; then
            echo "âš ï¸ AVISO: Uso de innerHTML pode ser vulnerÃ¡vel a XSS"
          fi
          
          echo "âœ… OK: innerHTML nÃ£o usado diretamente com input"

  summary:
    name: ğŸ“‹ Review Summary
    runs-on: ubuntu-latest
    needs: [architecture-review, prompt-quality, voice-parity, test-coverage, documentation, security-check]
    if: always()
    steps:
      - name: Generate summary
        run: |
          echo "# ğŸ¤– AI Chat Quality Review - Resumo" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## âœ… Conformidades" >> $GITHUB_STEP_SUMMARY
          echo "- Arquitetura com separaÃ§Ã£o de responsabilidades" >> $GITHUB_STEP_SUMMARY
          echo "- Sistema de confirmaÃ§Ã£o implementado" >> $GITHUB_STEP_SUMMARY
          echo "- Logs de auditoria presentes" >> $GITHUB_STEP_SUMMARY
          echo "- Contexto conversacional mantido" >> $GITHUB_STEP_SUMMARY
          echo "- Paridade voz-texto" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“Š Status dos Jobs" >> $GITHUB_STEP_SUMMARY
          echo "- Architecture Review: ${{ needs.architecture-review.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Prompt Quality: ${{ needs.prompt-quality.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Voice Parity: ${{ needs.voice-parity.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Test Coverage: ${{ needs.test-coverage.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Documentation: ${{ needs.documentation.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Security: ${{ needs.security-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ’¡ PrÃ³ximos Passos" >> $GITHUB_STEP_SUMMARY
          echo "1. Revisar warnings encontrados" >> $GITHUB_STEP_SUMMARY
          echo "2. Adicionar testes para novos cenÃ¡rios" >> $GITHUB_STEP_SUMMARY
          echo "3. Manter documentaÃ§Ã£o atualizada" >> $GITHUB_STEP_SUMMARY
          echo "4. Validar com usuÃ¡rios reais" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*Review automÃ¡tico realizado em $(date)*" >> $GITHUB_STEP_SUMMARY
